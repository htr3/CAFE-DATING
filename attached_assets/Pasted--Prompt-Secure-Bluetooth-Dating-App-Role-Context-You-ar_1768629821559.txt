# Prompt: Secure Bluetooth Dating App

## ğŸ“‹ Role & Context
You are a senior Android engineer with 10+ years of experience in Bluetooth Classic, Kotlin, Jetpack Compose, and Android security. You specialize in building production-ready, Play Store-compliant apps.

## ğŸ¯ Goal
Build a complete, working Android application for a Bluetooth-based dating/chat app that allows users to discover and chat with nearby people **without internet**, using **only Bluetooth**.

---

## ğŸ“± Core Requirements

### 1. Auto-Discovery (No Manual Buttons)
- App automatically starts Bluetooth discovery when opened
- App automatically starts Bluetooth server to accept connections
- Users see a live list of nearby app users
- No "Start Server" or "Scan" buttons - everything is automatic
- Continuous scanning with auto-refresh every few seconds

### 2. User Experience Flow
```
User opens app
    â†“
Auto-discovery starts (both server + scanning)
    â†“
Shows list of nearby users
    â†“
User taps a nearby person
    â†“
Connection request dialog on other person's phone
    â†“
Other person accepts/rejects
    â†“
If accepted: Both enter encrypted chat
    â†“
Real-time bidirectional messaging
```

### 3. Security (Play Store Compliant)
**MANDATORY - These are non-negotiable:**

- âœ… **User Consent**: Show "Accept/Reject" dialog for every connection attempt
- âœ… **Device Identity**: Generate unique UUID on first install (stored in EncryptedSharedPreferences)
- âœ… **Secure Handshake**: 
  ```
  Client â†’ Server: HELLO|clientUUID|clientName
  Server â†’ Client: ACCEPT|sessionKey OR REJECT|reason
  ```
- âœ… **End-to-End Encryption**: AES-256-CBC with random IV per message
- âœ… **Session Keys**: New session key per connection
- âœ… **Rate Limiting**: Max 5 messages per second per connection
- âœ… **Block Functionality**: Users can block devices permanently
- âœ… **No Message Storage**: All messages in-memory only (never saved to disk)
- âœ… **Background Safety**: Stop discovery when app goes to background

### 4. Technical Stack
- **Language**: Kotlin
- **UI**: Jetpack Compose with Material 3
- **Architecture**: MVVM (ViewModel, Repository, UseCase)
- **Bluetooth**: Bluetooth Classic (RFCOMM) - NOT BLE
- **Encryption**: AES-256 from javax.crypto
- **Storage**: EncryptedSharedPreferences for device UUID only
- **Async**: Kotlin Coroutines + Flow
- **Min SDK**: 26 (Android 8.0)
- **Target SDK**: 34 (Android 14)

### 5. File Structure
```
app/src/main/java/com/cafe/dating/app/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ local/
â”‚   â”‚   â”œâ”€â”€ SecurePreferences.kt (EncryptedSharedPreferences for UUID)
â”‚   â”‚   â””â”€â”€ BlockedDevicesRepository.kt (Store blocked device UUIDs)
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ BluetoothDeviceModel.kt
â”‚   â”‚   â”œâ”€â”€ ChatMessage.kt
â”‚   â”‚   â””â”€â”€ ConnectionRequest.kt
â”‚   â””â”€â”€ encryption/
â”‚       â””â”€â”€ EncryptionUtils.kt (AES-256 encrypt/decrypt)
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ bluetooth/
â”‚   â”‚   â”œâ”€â”€ BluetoothServer.kt (RFCOMM server socket)
â”‚   â”‚   â”œâ”€â”€ BluetoothClient.kt (RFCOMM client socket)
â”‚   â”‚   â”œâ”€â”€ DiscoveryManager.kt (Auto-discovery with BroadcastReceiver)
â”‚   â”‚   â”œâ”€â”€ SecureSocketManager.kt (Handles encrypted send/receive)
â”‚   â”‚   â””â”€â”€ HandshakeManager.kt (Connection handshake protocol)
â”‚   â””â”€â”€ usecases/
â”‚       â”œâ”€â”€ ConnectToDeviceUseCase.kt
â”‚       â””â”€â”€ SendMessageUseCase.kt
â”œâ”€â”€ presentation/
â”‚   â”œâ”€â”€ viewmodels/
â”‚   â”‚   â”œâ”€â”€ BluetoothViewModel.kt (Discovery, connections, server/client)
â”‚   â”‚   â””â”€â”€ ChatViewModel.kt (Message handling, chat state)
â”‚   â””â”€â”€ ui/
â”‚       â”œâ”€â”€ screens/
â”‚       â”‚   â”œâ”€â”€ NearbyUsersScreen.kt (List of discovered users)
â”‚       â”‚   â””â”€â”€ ChatScreen.kt (Chat interface with messages)
â”‚       â””â”€â”€ dialogs/
â”‚           â””â”€â”€ ConnectionRequestDialog.kt (Accept/Reject dialog)
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ PermissionManager.kt (Permission checking helpers)
â”‚   â””â”€â”€ RateLimiter.kt (5 messages/sec limit)
â””â”€â”€ MainActivity.kt (Lifecycle, permissions, navigation)
```

---

## ğŸ”§ Detailed Component Specifications

### EncryptionUtils.kt
```kotlin
- generateSessionKey(): SecretKey (AES-256)
- keyToString(key): String (for transmission)
- stringToKey(keyString): SecretKey
- encrypt(message: String, key: SecretKey): String
  â†’ Generate random 16-byte IV
  â†’ Encrypt with AES/CBC/PKCS5Padding
  â†’ Return Base64(IV + encryptedData)
- decrypt(encryptedMessage: String, key: SecretKey): String
  â†’ Decode Base64
  â†’ Extract IV (first 16 bytes)
  â†’ Decrypt remaining bytes
  â†’ Return plaintext
```

### HandshakeManager.kt
```kotlin
- performClientHandshake(): SecretKey?
  â†’ Send "HELLO|uuid|name\n"
  â†’ Wait for "ACCEPT|sessionKey\n" or "REJECT|reason\n"
  â†’ Return session key or null
  
- performServerHandshake(): Pair<String, SecretKey>?
  â†’ Read "HELLO|uuid|name\n"
  â†’ Call onConnectionRequest(uuid, name) â†’ Boolean
  â†’ If accepted: Generate session key, send "ACCEPT|key\n"
  â†’ If rejected: Send "REJECT|reason\n"
  â†’ Return (clientUUID, sessionKey) or null
```

### SecureSocketManager.kt
```kotlin
- Constructor(socket, sessionKey, remoteDeviceUUID)
- startListening(): Start thread to read messages
  â†’ Read until '\n'
  â†’ Decrypt with session key
  â†’ Emit to messageFlow: SharedFlow<ChatMessage>
- sendMessage(message: String): Boolean
  â†’ Check rate limit (5/sec)
  â†’ Encrypt with session key
  â†’ Write with '\n' delimiter
  â†’ Return success/failure
- connectionState: SharedFlow<ConnectionState>
```

### BluetoothServer.kt
```kotlin
- start(context): Boolean
  â†’ listenUsingRfcommWithServiceRecord(name, UUID)
  â†’ Loop: accept() connections
  â†’ For each connection: perform handshake
  â†’ If accepted: emit ConnectionEstablished(SecureSocketManager)
- connectionFlow: SharedFlow<ServerEvent>
  â†’ Started, Stopped, ConnectionRequested, ConnectionEstablished, Error
```

### DiscoveryManager.kt
```kotlin
- startDiscovery()
  â†’ Register BroadcastReceiver for ACTION_FOUND
  â†’ startDiscovery()
  â†’ On ACTION_DISCOVERY_FINISHED: wait 3s, restart
- discoveredDevices: StateFlow<List<BluetoothDeviceModel>>
- Filter out blocked devices
- Auto-rescan continuously
```

### BluetoothViewModel.kt
```kotlin
- startAutoMode()
  â†’ Start BluetoothServer
  â†’ Start DiscoveryManager
- connectToDevice(device)
  â†’ Use BluetoothClient to connect
  â†’ Perform handshake
  â†’ Create SecureSocketManager
  â†’ Navigate to chat
- acceptConnection() / rejectConnection()
  â†’ For incoming connection requests
- discoveredDevices: StateFlow
- connectionState: StateFlow
- connectionRequest: StateFlow (for dialog)
```

### ChatViewModel.kt
```kotlin
- initializeChat(socket, deviceName)
  â†’ socket.startListening()
  â†’ Collect socket.messageFlow â†’ add to messages list
  â†’ Collect socket.connectionState
- sendMessage(content)
  â†’ Use SendMessageUseCase
  â†’ Add sent message to list
- messages: StateFlow<List<ChatMessage>>
- connectionState: StateFlow
```

### MainActivity.kt
```kotlin
- onCreate()
  â†’ Check Bluetooth support
  â†’ Request enable Bluetooth
  â†’ Request permissions (Bluetooth + Location)
  â†’ Request discoverable mode (300 seconds)
  â†’ Start auto mode
- onResume(): Restart discovery if idle
- onPause(): Stop discovery to save battery
- Navigation: NearbyUsersScreen â†” ChatScreen
- Show ConnectionRequestDialog as overlay
```

---

## ğŸ¨ UI Requirements

### NearbyUsersScreen
- Header: "â˜• CafÃ© Dating"
- Security badge: "ğŸ”’ End-to-End Encrypted â€¢ AES-256"
- Status card: Shows scanning status, device count
- User list: Cards with user icon, name, "Tap to connect"
- Empty state: "No users nearby" with helpful tips
- Refresh button

### ChatScreen
- Top bar: User name, "ğŸ”’ Encrypted" status, menu (Block, Disconnect)
- Message list: Chat bubbles (blue for sent, gray for received)
- Timestamps on messages
- Input field + Send button
- Empty state: "ğŸ’¬ Start the conversation!"
- Rate limit warning if exceeded

### ConnectionRequestDialog
- Icon: ğŸ“±
- Title: "Connection Request"
- Text: "[Name] wants to connect. Accept?"
- Buttons: "âœ… Accept" and "âŒ Reject"

---

## ğŸ“‹ AndroidManifest.xml

```xml
<!-- Bluetooth (Android 11 and below) -->
<uses-permission android:name="android.permission.BLUETOOTH" android:maxSdkVersion="30" />
<uses-permission android:name="android.permission.BLUETOOTH_ADMIN" android:maxSdkVersion="30" />

<!-- Bluetooth (Android 12+) -->
<uses-permission android:name="android.permission.BLUETOOTH_SCAN" 
    android:usesPermissionFlags="neverForLocation" />
<uses-permission android:name="android.permission.BLUETOOTH_CONNECT" />
<uses-permission android:name="android.permission.BLUETOOTH_ADVERTISE" />

<!-- Location (required for Bluetooth scanning) -->
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />

<uses-feature android:name="android.hardware.bluetooth" android:required="true" />
```

---

## ğŸ› Common Issues to Avoid

### Issue 1: Discovery Not Working
**Cause**: Location/GPS is OFF or permission denied
**Fix**: 
- Check Location is ON in phone settings
- Request ACCESS_FINE_LOCATION permission
- Add clear error messages

### Issue 2: Devices Not Appearing
**Cause**: Only checking BLUETOOTH_SCAN, missing Location permission
**Fix**: 
- Android requires Location permission for Bluetooth scanning
- Check both permissions before starting discovery

### Issue 3: One-Way Messaging
**Cause**: Only one side calls startListening() or wrong session key
**Fix**:
- BOTH phones must call socket.startListening()
- BOTH phones must collect messageFlow in ChatViewModel
- Ensure handshake gives same session key to both sides

### Issue 4: Connection Fails Silently
**Cause**: No user feedback during connection
**Fix**:
- Show "Connecting..." overlay
- Show error messages with auto-dismiss
- Log everything to Logcat

### Issue 5: Battery Drain
**Cause**: Discovery continues in background
**Fix**:
- Stop discovery in onPause()
- Restart in onResume()
- Keep connection alive during chat

---

## âœ… Testing Checklist

### Before Testing:
- [ ] Install on 2 physical Android phones (emulators don't support Bluetooth well)
- [ ] Both phones: Bluetooth ON
- [ ] Both phones: Location/GPS ON
- [ ] Both phones: All permissions granted
- [ ] Phones within 5 meters

### Test Scenarios:
1. **Auto-Discovery**: Both phones open app â†’ see each other in list
2. **Connection Request**: Tap user â†’ dialog appears on other phone
3. **Accept Connection**: Accept â†’ both enter chat screen
4. **Reject Connection**: Reject â†’ connection fails gracefully
5. **Send Message Aâ†’B**: Phone A sends â†’ appears on Phone B
6. **Send Message Bâ†’A**: Phone B sends â†’ appears on Phone A
7. **Rate Limiting**: Send 10 messages rapidly â†’ some blocked
8. **Block User**: Block â†’ user disappears, can't reconnect
9. **Disconnect**: End chat â†’ return to discovery, auto-rescan
10. **Background/Foreground**: Home â†’ Return â†’ discovery restarts

---

## ğŸ“¦ Deliverables

Please provide:

1. **Complete Source Code**: All Kotlin files with proper package structure
2. **AndroidManifest.xml**: With all required permissions
3. **build.gradle**: With dependencies (Compose, Coroutines, Security-Crypto)
4. **README.md**: Build instructions and testing steps
5. **Testing Guide**: Step-by-step testing on 2 phones
6. **Troubleshooting Guide**: Common issues and fixes

---

## ğŸ¯ Success Criteria

The app is complete when:
- âœ… Opens and automatically starts discovery
- âœ… Shows nearby users within 15 seconds
- âœ… Connection requires user consent (dialog)
- âœ… Messages work in BOTH directions
- âœ… All messages are encrypted (AES-256)
- âœ… Works completely offline (no internet)
- âœ… No crashes, proper error handling
- âœ… Battery-efficient (stops discovery in background)
- âœ… Play Store compliant (security, permissions)

---

## ğŸ’¡ Additional Notes

- Use descriptive variable names (not `i`, `j`, `x`, `y`)
- Add comprehensive comments explaining each step
- Include debug logging (Log.d) for troubleshooting
- Handle all edge cases (permission denied, Bluetooth off, etc.)
- Material 3 design with smooth animations
- Dark mode support

---

## ğŸš€ Bonus Features (Optional)

If time permits, add:
- User profile name customization
- Message delivery confirmation (âœ“/âœ“âœ“)
- Typing indicator
- Message timestamps (e.g., "just now", "5m ago")
- Connection strength indicator
- Auto-reconnect if connection drops
- Sound notification for new messages

---

**Generate complete, production-ready code that I can copy-paste and build immediately. Prioritize functionality over perfection - make it work first, then we can optimize.**

---

## Example Usage

```
PROMPT:
"Using the specifications above, generate complete code for SecureSocketManager.kt 
with bidirectional encrypted messaging, proper error handling, and detailed logging."

or

"Generate the complete MainActivity.kt that handles auto-discovery, permissions, 
and navigation between NearbyUsersScreen and ChatScreen."

or

"Create the full project structure with all files, following the MVVM architecture 
specified above. Include complete, working implementations."
```

---

**Start with the most critical components first:**
1. EncryptionUtils (AES-256)
2. HandshakeManager (Connection protocol)
3. SecureSocketManager (Bidirectional messaging)
4. BluetoothServer + BluetoothClient
5. DiscoveryManager (Auto-discovery)
6. ViewModels (State management)
7. UI Screens (Compose)
8. MainActivity (Integration)

**Make it production-ready, secure, and Play Store compliant!** ğŸš€